---
layout: base
---

{%- comment -%}
Compute the space root and find the space index page.
Works for both /specs/... and /drafts/... because we use the pageâ€™s collection.
{%- endcomment -%}
{%- assign root = page.url | replace: '/index.html','/' -%}
{%- assign col  = page.collection | default: 'specs' -%}
{%- assign coll = site[col] | default: site.specs -%}
{%- assign space_index = coll | where: "url", root | first -%}
{%- assign meta = space_index | default: page -%}

<div class="navbar">
  <div class="title-group" onclick="goHome()">
    <span class="home-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 .5l6.5 6V15a1 1 0 0 1-1 1H11a1 1 0 0 1-1-1V10H6v5a1 1 0 0 1-1 1H2.5a1 1 0 0 1-1-1V6.5L8 .5z" />
      </svg>
    </span>
  </div>
  
    {% assign repo = site.github.repository_url | default: site.repo_url %}
    <div class="actions1">
      <a class="btn primary" href="https://github.com/pranavwani/design-spec-v2/issues/new?template=new-spec.yml"
        target="_blank" rel="noopener">
        Submit a New Design Spec
      </a>
      <a class="btn" href="https://github.com/pranavwani/design-spec-v2/issues/new?template=update-spec.yml"
        target="_blank" rel="noopener">
        Submit an Update
      </a>
    </div>
  </div>

  <!-- Main -->
  <main class="wrap">
  <div class="main">
    <div class="header">
      <h1 class="spec-heading">{{ page.title }}</h1>
      <div class="tags">
        {%- if meta.epic -%}
      {%- assign _epic = meta.epic | strip -%}
      {%- if site.jira and site.jira.base_url -%}
        <a class="tag" href="{{ site.jira.base_url | append: '/' | append: _epic }}" target="_blank" rel="noopener">
          Epic {{ _epic }}
        </a>
      {%- else -%}
        <span class="tag">Epic {{ _epic }}</span>
      {%- endif -%}
    {%- endif -%}
    {%- if meta.status -%}
      <span class="tag active">{{ meta.status | capitalize }}</span>
    {%- endif -%}
    {%- if meta.updated_at -%}
      <span class="tag">Updated {{ meta.updated_at }}</span>
    {%- endif -%}
    {%- if meta.owner -%}
      {%- assign _owner = meta.owner | strip -%}
      {%- if _owner | slice: 0, 1 == '@' -%}
        {%- assign _handle = _owner | remove: '@' -%}
        <a class="tag owner" href="https://github.com/{{ _handle | uri_escape }}" target="_blank" rel="noopener" title="Open {{ _owner }} on GitHub">
          Owner {{ _owner }}
        </a>
      {%- else -%}
        <span class="tag owner">Owner {{ _owner }}</span>
      {%- endif -%}
    {%- endif -%}
    {%- if meta.team -%}
      <span class="tag">Team {{ meta.team }}</span>
    {%- endif -%}
    {%- if meta.created_at -%}
      <span class="tag">Created {{ meta.created_at }}</span>
    {%- endif -%}

      </div>
    </div>
     </div> 

{%- comment -%}
Collect files that belong to this space, keep only top-level (index + first-level pages),
and build a normalized list with label/order (front-matter wins; otherwise map/fallback).
{%- endcomment -%}
{%- assign space_dir = page.path | replace: '/index.md','/' -%}
{%- assign docs = coll | where_exp:'d', "d.path contains space_dir" -%}
{%- assign docs = docs | sort: 'nav_order' -%}

{%- assign normalized = "" | split: "" -%}
{%- assign order_map = "overview:0|hld:10|lld:20|data-model:25|api:30|ux:40|rollout-ops:50|qa-test:60" | split:"|" -%}

{%- for d in docs -%}
  {%- assign depth = d.path | remove_first: space_dir | split:'/' | size -%}
  {%- if depth > 1 -%}{% continue %}{%- endif -%}

  {%- assign href = d.url | replace: '/index.html','/' -%}
  {%- assign rel = d.path | remove_first: space_dir -%}
  {%- assign slug = rel | replace: 'index.md','overview' | replace: '.md','' | downcase -%}

  {%- assign label = d.nav_title | default: d.title -%}
  {%- if label == nil or label == "" -%}
    {%- case slug -%}
      {%- when 'overview' -%}{%- assign label = 'Overview' -%}
      {%- when 'hld' -%}{%- assign label = 'High-Level Design' -%}
      {%- when 'lld' -%}{%- assign label = 'Low-Level Design' -%}
      {%- when 'data-model' -%}{%- assign label = 'Data Model' -%}
      {%- when 'api' -%}{%- assign label = 'API' -%}
      {%- when 'ux' -%}{%- assign label = 'UX' -%}
      {%- when 'rollout-ops' -%}{%- assign label = 'Rollout & Ops' -%}
      {%- when 'qa-test' -%}{%- assign label = 'QA / Test Plan' -%}
      {%- else -%}
        {%- assign label = slug | replace:'-',' ' | capitalize -%}
    {%- endcase -%}
  {%- endif -%}

  {%- assign order = d.nav_order -%}
  {%- if order == nil or order == "" -%}
    {%- assign mapped = 999 -%}
    {%- for p in order_map -%}
      {%- assign k = p | split:':' | first -%}
      {%- assign v = p | split:':' | last  -%}
      {%- if slug == k -%}{%- assign mapped = v -%}{%- endif -%}
    {%- endfor -%}
    {%- assign order = mapped -%}
  {%- endif -%}

  {%- assign active = page.url == d.url -%}
  {%- assign item = '{"href":"__H__","label":"__L__","order":__O__,"active":__A__}' 
      | replace:'__H__', href 
      | replace:'__L__', label 
      | replace:'__O__', order 
      | replace:'__A__', active -%}
  {%- assign normalized = normalized | push: item -%}
{%- endfor -%}

{%- assign sorted = normalized | sort: 'order' -%}

<div class="spec-grid">
  <aside class="sidebar1">
  <nav class="sidebar-nav1">
    <ul class="side-links1">
      {%- for d in docs -%}
        {%- assign rel = d.path | remove_first: space_dir -%}
        {%- assign depth = rel | split:'/' | size -%}
        {%- if depth > 1 -%}{% continue %}{%- endif -%}

        {%- assign href = d.url | replace: '/index.html','/' -%}
        {%- assign is_active = page.url == d.url -%}
        <li>
          <a href="{{ href | relative_url }}"
             class="side-link1 {% if is_active %}active{% endif %}"
             {% if is_active %}aria-current="page"{% endif %}>
            {{ d.nav_title | default: d.title | default: 'Untitled' }}
          </a>
        </li>
      {%- endfor -%}
    </ul>
  </nav>
</aside>

  <main id="spec-content" class="content">
  <div id="raw-content">
    {{ content }}
  </div>
</main>

</div>

{%- comment -%}
PJAX-lite: intercept leftbar clicks, fetch target page, swap only #spec-content.
Header + leftbar remain static. Degrades gracefully (normal links) if JS fails.
{%- endcomment -%}
</main>
<script>
  (function () {
    const containerSel = '#spec-content';
    const navSel = '.sidebar-nav1 a, .side-links1 a';

    function sameOrigin(href) {
      try { return new URL(href, location.href).origin === location.origin; }
      catch { return false; }
    }

    function setActive(absHref) {
      document.querySelectorAll(navSel).forEach(a => {
        const match = new URL(a.href, location.href).href === absHref;
        a.classList.toggle('active', match);
        if (match) a.setAttribute('aria-current', 'page');
        else a.removeAttribute('aria-current');
      });
    }

    async function load(href, { push = true, scroll = true } = {}) {
      const abs = new URL(href, location.href).href;
      const res = await fetch(abs, { headers: { 'X-PJAX': '1' } });
      if (!res.ok) throw new Error('Fetch failed: ' + abs);

      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const next = doc.querySelector(containerSel);
      const curr = document.querySelector(containerSel);
      if (!next || !curr) return location.assign(abs);

      const main = document.createElement("main");
      main.id = "spec-content";
      main.className = "content";
      const raw1 = next.querySelector("#raw-content");
      main.appendChild(raw1);
      const sections1 = [];
      let current1;

      [...raw1.childNodes].forEach(node => {
        if (node.tagName === "H2" || node.tagName === "H1") {
          if (current1) sections1.push(current1);
          current1 = document.createElement("div");
          current1.className = "content-card1";
          current1.appendChild(node);
        } else if (current1) {
          current1.appendChild(node);
        }
      });

      if (current1) sections1.push(current1);

      raw1.innerHTML = "";
      sections1.forEach(sec => raw1.appendChild(sec));

      curr.style.opacity = '0.35';
      curr.replaceWith(main);
      main.style.opacity = '1';

      if (doc.title) document.title = doc.title;
      setActive(abs);
     // if (scroll) raw1.scrollIntoView({ block: 'start' });
      if (push) history.pushState({ pjax: true, url: abs }, '', abs);
    }

    document.addEventListener('click', (e) => {
      const a = e.target.closest(navSel);
      if (!a) return;
      if (e.defaultPrevented || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

      const href = a.getAttribute('href');
      if (!href || href.startsWith('#') || !sameOrigin(href)) return;

      e.preventDefault();
      load(href).catch(() => location.assign(href));
    });

    window.addEventListener('popstate', (e) => {
      if (e.state && e.state.pjax && e.state.url) {
        load(e.state.url, { push: false }).catch(() => location.reload());
      }
    });

    setActive(location.href);
  })();

  document.addEventListener("DOMContentLoaded", () => {
  const raw = document.querySelector("#raw-content");
  const sections = [];
  let current;

  [...raw.childNodes].forEach(node => {
    if (node.tagName === "H2" || node.tagName === "H1") {
      if (current) sections.push(current);
      current = document.createElement("div");
      current.className = "content-card1";
      current.appendChild(node);
    } else if (current) {
      current.appendChild(node);
    }
  });

  if (current) sections.push(current);

  raw.innerHTML = "";
  sections.forEach(sec => raw.appendChild(sec));
});

function goHome() {
    window.location.href = "/design-spec-v1/";
  }
</script>
